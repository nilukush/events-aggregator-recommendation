# EventNexus - Scheduled Event Ingestion
# This workflow runs every hour to fetch events from all sources
# across ALL configured cities and stores them in the Supabase database.

name: Event Ingestion

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  ingest-events:
    name: Fetch and Store Events
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Prevent multiple concurrent runs
    concurrency:
      group: event-ingestion
      cancel-in-progress: false

    strategy:
      matrix:
        # All cities configured in the frontend CitySelector component
        # This ensures we have events from all regions users can filter by
        city:
          - { name: "Dubai", lat: 25.2048, lng: 55.2708, radius: 50 }
          - { name: "Abu Dhabi", lat: 24.4539, lng: 54.3773, radius: 50 }
          - { name: "Sharjah", lat: 25.3467, lng: 55.4097, radius: 50 }
          - { name: "Riyadh", lat: 24.7136, lng: 46.6753, radius: 50 }
          - { name: "Doha", lat: 25.2854, lng: 51.5310, radius: 50 }
          - { name: "Kuwait City", lat: 29.3759, lng: 47.9774, radius: 50 }
          - { name: "Manama", lat: 26.0667, lng: 50.5577, radius: 50 }
          - { name: "Muscat", lat: 23.5859, lng: 58.3849, radius: 50 }
          - { name: "Jeddah", lat: 21.5433, lng: 39.1728, radius: 50 }
          - { name: "Singapore", lat: 1.3521, lng: 103.8198, radius: 50 }
          - { name: "London", lat: 51.5074, lng: -0.1278, radius: 50 }
          - { name: "New York", lat: 40.7128, lng: -74.0060, radius: 50 }
          - { name: "San Francisco", lat: 37.7749, lng: -122.4194, radius: 50 }
          - { name: "Los Angeles", lat: 34.0522, lng: -118.2437, radius: 50 }
          - { name: "Toronto", lat: 43.6532, lng: -79.3832, radius: 50 }
          - { name: "Sydney", lat: -33.8688, lng: 151.2093, radius: 50 }
          - { name: "Mumbai", lat: 19.0760, lng: 72.8777, radius: 50 }
          - { name: "Delhi", lat: 28.7041, lng: 77.1025, radius: 50 }
          - { name: "Bangalore", lat: 12.9716, lng: 77.5946, radius: 50 }
          - { name: "Tokyo", lat: 35.6762, lng: 139.6503, radius: 50 }
          - { name: "Paris", lat: 48.8566, lng: 2.3522, radius: 50 }
          - { name: "Berlin", lat: 52.5200, lng: 13.4050, radius: 50 }
          - { name: "Amsterdam", lat: 52.3676, lng: 4.9041, radius: 50 }
          - { name: "Barcelona", lat: 41.3851, lng: 2.1734, radius: 50 }
      fail-fast: false  # Continue with other cities even if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Trigger event ingestion for ${{ matrix.city.name }}
        run: |
          INGEST_URL="${{ secrets.INGEST_URL }}"
          CITY="${{ matrix.city.name }}"
          LAT="${{ matrix.city.lat }}"
          LNG="${{ matrix.city.lng }}"
          RADIUS_KM="${{ matrix.city.radius }}"

          # Build query parameters
          QUERY="?city=${CITY}&location_lat=${LAT}&location_lng=${LNG}&radius_km=${RADIUS_KM}"

          echo "Triggering event ingestion for ${CITY}: ${INGEST_URL}${QUERY}"

          # Retry logic (up to 3 attempts)
          MAX_RETRIES=3
          RETRY_COUNT=0
          HTTP_CODE=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$HTTP_CODE" -ne 200 ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "Retry $RETRY_COUNT/$MAX_RETRIES for ${CITY}..."
              sleep 5
            fi

            RESPONSE=$(curl -s -X POST "${INGEST_URL}${QUERY}" \
              -H "Content-Type: application/json" \
              --max-time 60 \
              -w "\n%{http_code}")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n -1)

            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Event ingestion completed successfully for ${CITY}"
          else
            echo "Event ingestion failed for ${CITY} after $RETRY_COUNT attempts with status code: $HTTP_CODE"
            # Don't fail the workflow - continue to next city
          fi
        env:
          INGEST_URL: ${{ secrets.INGEST_URL }}

      - name: Summary
        if: always()
        run: |
          echo "Event ingestion workflow completed at $(date)"
          echo "City processed: ${{ matrix.city.name }}"
